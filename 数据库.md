# mysql

## 启动服务

centOS使用`systemctl`启动、关闭、重启服务`mysqld`。然后会自动取调用mysqld.service

```shell
systemctl enable mysqld   #允许mysql自启动，start\stop\restart
systemctl list-unit-files |grep mysql  #查看自启动程序列表
mysql -u root -h localhost -p  #登录mysql
```

## 用户管理

+ 新增用户：`insert into user (host,user,ssl_cipher,x509_issuer,x509_subject) values('%','admin','','','');`;
  + `ssl_cipher,x509_issuer,x509_subject`这三个字段必须有。取消了`password`字段。
  + 不支持`grant`添加用户。
+ 修改权限：新增用户后，需要刷新数据库`flush privileges;`后，再进行`GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%';`

![image-20210320205155906](img/image-20210320205155906.png)

+ 远程连接：需要修改用户的host为客户端的ip或者`%`，同时还要让防火墙开通3306端口。

  ```shell
  firewall-cmd --zone=public --add-port=3306/tcp --permanent  #开通3306端口
  firewall-cmd --list-ports  #查看开通的端口
  ```

## 知识点

+ 索引是关系数据库中对某一列或多个列的值进行预排序的数据结构。通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录，这样就大大加快了查询速度。

## 表操作

### 基本查询

```mysql
SELECT 列名称 FROM 表名称									#查询
SELECT DISTINCT 列名称 FROM 表名称						#去重
SELECT 列名称 FROM 表名称 WHERE 条件					   #条件查询	不等于<> BETWEEN LIKE AND OR
SELECT 列名称 FROM 表名称 ORDER BY 列	  				    #顺序		  降序 DESC ASC
SELECT 列名称 FROM 表名称 GROUP BY 列						#分组
INSERT INTO 列名称 (列1, 列2,...) VALUES (值1, 值2,....)	#插入 不声明列，则表示所有列
UPDATE 表名称 SET 列名称 = 新值 WHERE 列名称 = 某值			#更新
DELETE FROM 表名称 WHERE 列名称 = 值						#删除
SELECT 列名称 FROM 表名称	LIMIT M OFFSET N				 #分页 每页M条数据，第N页 offset x表示跳过x条语句
```

### 高级

- [ ] 通配符：% 任意字符，_ 单个字符，[] 列表， [^] 取反
- [ ] 关联：输出优先级。
- `[INNER] JOIN`: 如果两表中有至少一个匹配，则返回行，
- `LEFT JOIN`: 即使右表中没有匹配，也从左表返回所有的行
- `RIGHT JOIN`: 即使左表中没有匹配，也从右表返回所有的行
- `FULL JOIN`: 只要其中一个表中存在匹配，就返回行

|       关键字       |                作用                 |                             例子                             |
| :----------------: | :---------------------------------: | :----------------------------------------------------------: |
|       LIMIT        |        要返回的记录的数目。         |                SELECT * FROM Persons LIMIT 5                 |
|        LIKE        | 在 WHERE 子句中搜索列中的指定模式。 |          SELECT * FROM Persons WHERE City LIKE 'N%'          |
|         IN         |              列表范围               |  SELECT * FROM Persons WHERE LastName IN ('Adams','Carter')  |
|  BETWEEN ... AND   |              两值之间               | SELECT column_name(s) FROM table_name WHERE column_name BETWEEN value1 AND value2 |
|         AS         |                别名                 |     SELECT column_name(s) FROM table_name AS alias_name      |
|       COUNT        |              统计行数               |              SELECT COUNT(*) num FROM students;              |
| SUM、AVG、MAX、MIN |      列求和、平均、最大、最小       | SELECT AVG(score) average FROM students WHERE gender = 'X';  |
|      GROUP BY      |                分组                 |     SELECT COUNT(*) num FROM students GROUP BY class_id;     |
|         ON         |            确定连接条件             | SELECT * FROM students s INNER JOIN classes cON s.class_id = c.id; |

- [ ] 数据类型
- 整数：integer(size)、smallint、int 
- 浮点数：decimal(size,d)、numeric
- 字符：char(size)、varchar
- 时间：date(yyyymmdd)
- @是用户变量，@@是系统变量。

```mysql
CREATE DATABASE database_name			#创建数据库
CREATE TABLE 表名称					  #创建表
(
    列名称1 数据类型 NOT NULL,							# 不接受 NULL 值
    列名称2 数据类型 DEFAULT 'Sandnes',				# 默认值
    列名称3 数据类型 AUTO_INCREMENT,					# 在新记录插入表中时生成一个唯一的数字。
    ....
    PRIMARY KEY(Id_p)								# 主键 唯一值
    UNIQUE (idx) 									# 唯一值
    FOREIGN KEY (Id_P) REFERENCES Persons(Id_P)		# 外键约束，用于预防破坏表之间连接的动作。
    CONSTRAINT chk_Person CHECK (Id_P>0 AND City='Sandnes') # 检查
)
CREATE INDEX index_name ON table_name (column_name) # 创建索引
ALTER TABLE table_name DROP INDEX index_name		# 删除索引、表和数据库。
ALTER TABLE table_name ADD column_name datatype  	# 已有的表中添加、修改或删除列。

CREATE VIEW view_name AS 		# 视图包含行和列，就像一个真实的表。
SELECT column_name(s)
FROM table_name
WHERE condition
```

## 函数

```mysql
IFNULL(expression, alt_value)		#判断是否为null,不为null返回本来的值，否则alt_value
```



## 事务

数据库事务具有ACID：

- A：Atomic，原子性，将所有SQL作为原子工作单元执行，要么全部执行，要么全部不执行；
- C：Consistent，一致性，事务完成后，所有数据的状态都是一致的，即A账户只要减去了100，B账户则必定加上了100；
- I：Isolation，隔离性，如果有多个事务并发执行，每个事务作出的修改必须与其他事务隔离；
- D：Duration，持久性，即事务完成后，对数据库数据的修改被持久化存储。

```mysql
BEGIN;   #显示事务
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;

#可以用ROLLBACK回滚事务，
```



